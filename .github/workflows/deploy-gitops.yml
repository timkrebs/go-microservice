name: Deploy (GitOps)

on:
  workflow_run:
    workflows: ["Docker Build and Publish"]
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
      image_tag:
        description: 'Image tag to deploy (sha-xxxxx format)'
        required: true
        default: 'sha-'

jobs:
  update-manifests:
    name: Update Kubernetes Manifests
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') ||
      github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine image tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TAG="${{ github.event.inputs.image_tag }}"
          elif [ "${{ github.event_name }}" == "workflow_run" ]; then
            # Get the SHA from the workflow that triggered this run
            TAG="sha-${{ github.event.workflow_run.head_sha }}"
          else
            TAG="sha-${{ github.sha }}"
          fi
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "Deploying tag: ${TAG}"
          echo "Event: ${{ github.event_name }}"
          echo "Workflow run SHA: ${{ github.event.workflow_run.head_sha }}"

      - name: Determine environment
        id: env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENV="${{ github.event.inputs.environment }}"
          else
            ENV="dev"
          fi
          echo "environment=${ENV}" >> $GITHUB_OUTPUT
          echo "Deploying to: ${ENV}"

      - name: Install Kustomize
        run: |
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
          sudo mv kustomize /usr/local/bin/

      - name: Update kustomization with new image tags
        run: |
          ENV=${{ steps.env.outputs.environment }}
          TAG=${{ steps.tag.outputs.tag }}
          
          cd deployments/kubernetes/overlays/${ENV}
          
          # Update kustomization.yaml with new image tags
          # This uses kustomize edit set image command
          kustomize edit set image \
            ghcr.io/timkrebs/go-microservice-api=ghcr.io/timkrebs/go-microservice-api:${TAG} \
            ghcr.io/timkrebs/go-microservice-worker=ghcr.io/timkrebs/go-microservice-worker:${TAG} \
            ghcr.io/timkrebs/go-microservice-frontend=ghcr.io/timkrebs/go-microservice-frontend:${TAG}
          
          cat kustomization.yaml

      - name: Commit and push changes
        run: |
          ENV=${{ steps.env.outputs.environment }}
          TAG=${{ steps.tag.outputs.tag }}
          
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          git add deployments/kubernetes/overlays/${ENV}/kustomization.yaml
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update ${ENV} images to ${TAG}"
            git push
            echo "âœ… Manifests updated - ArgoCD will sync automatically"
          fi

      - name: Deployment summary
        run: |
          ENV=${{ steps.env.outputs.environment }}
          TAG=${{ steps.tag.outputs.tag }}
          
          echo "## Deployment Initiated ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${ENV}" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag:** ${TAG}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ArgoCD will automatically sync the changes within 3 minutes." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Monitor deployment:" >> $GITHUB_STEP_SUMMARY
          echo "- ArgoCD UI: https://argocd.qnt9.com" >> $GITHUB_STEP_SUMMARY
          echo "- Application: image-processor-${ENV}" >> $GITHUB_STEP_SUMMARY

  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: [update-manifests]
    if: always() && vars.SLACK_WEBHOOK != ''
    steps:
      - name: Send Slack notification
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "Deployment to ${{ needs.update-manifests.outputs.environment }} initiated",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Deployment Status: ${{ needs.update-manifests.result }}*\nEnvironment: ${{ needs.update-manifests.outputs.environment }}\nTag: ${{ needs.update-manifests.outputs.tag }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
