apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: image-processor

resources:
- ../../base

images:
- name: ghcr.io/timkrebs/go-microservice-api
  newName: ghcr.io/timkrebs/go-microservice-api
  newTag: sha-7ded99e04b2cfcc5316ce2fba78818f054acbc1f
- name: ghcr.io/timkrebs/go-microservice-frontend
  newName: ghcr.io/timkrebs/go-microservice-frontend
  newTag: sha-7ded99e04b2cfcc5316ce2fba78818f054acbc1f
- name: ghcr.io/timkrebs/go-microservice-worker
  newName: ghcr.io/timkrebs/go-microservice-worker
  newTag: sha-7ded99e04b2cfcc5316ce2fba78818f054acbc1f
- name: image-processor-api
  newName: ghcr.io/timkrebs/go-microservice-api
  newTag: latest
- name: image-processor-frontend
  newName: ghcr.io/timkrebs/go-microservice-frontend
  newTag: latest
- name: image-processor-worker
  newName: ghcr.io/timkrebs/go-microservice-worker
  newTag: latest

# Development-specific patches
  # Reduce resource limits for development

  # Single replica in dev

  # Reduce HPA settings for dev

  # Reduce KEDA max replicas for dev
  # Single frontend replica in dev
patches:
- patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/resources/limits/cpu
      value: 200m
    - op: replace
      path: /spec/template/spec/containers/0/resources/limits/memory
      value: 256Mi
  target:
    kind: Deployment
    name: api
- patch: |-
    - op: replace
      path: /spec/replicas
      value: 1
  target:
    kind: Deployment
    name: api
- patch: |-
    - op: replace
      path: /spec/minReplicas
      value: 1
    - op: replace
      path: /spec/maxReplicas
      value: 3
  target:
    kind: HorizontalPodAutoscaler
    name: api-hpa
- patch: |-
    - op: replace
      path: /spec/maxReplicaCount
      value: 5
  target:
    kind: ScaledObject
    name: worker-scaledobject
- patch: |-
    - op: replace
      path: /spec/replicas
      value: 1
  target:
    kind: Deployment
    name: frontend
commonLabels:
  environment: development
