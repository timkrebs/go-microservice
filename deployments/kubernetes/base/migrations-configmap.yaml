apiVersion: v1
kind: ConfigMap
metadata:
  name: db-migrations
  namespace: image-processor
data:
  001_init.up.sql: |
    -- Create jobs table
    CREATE TABLE IF NOT EXISTS jobs (
        id UUID PRIMARY KEY,
        status VARCHAR(20) NOT NULL DEFAULT 'pending',
        original_key VARCHAR(512) NOT NULL,
        processed_key VARCHAR(512),
        original_name VARCHAR(255) NOT NULL,
        content_type VARCHAR(100) NOT NULL,
        file_size BIGINT NOT NULL,
        operations JSONB NOT NULL DEFAULT '[]',
        error TEXT,
        progress INTEGER NOT NULL DEFAULT 0,
        worker_id VARCHAR(100),
        created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
        updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
        started_at TIMESTAMP WITH TIME ZONE,
        completed_at TIMESTAMP WITH TIME ZONE,
        processing_time_ms BIGINT
    );

    -- Create indexes for common queries
    CREATE INDEX idx_jobs_status ON jobs(status);
    CREATE INDEX idx_jobs_created_at ON jobs(created_at DESC);
    CREATE INDEX idx_jobs_worker_id ON jobs(worker_id) WHERE worker_id IS NOT NULL;

    -- Create updated_at trigger function
    CREATE OR REPLACE FUNCTION update_updated_at_column()
    RETURNS TRIGGER AS $$
    BEGIN
        NEW.updated_at = NOW();
        RETURN NEW;
    END;
    $$ language 'plpgsql';

    -- Create trigger for updated_at
    CREATE TRIGGER update_jobs_updated_at
        BEFORE UPDATE ON jobs
        FOR EACH ROW
        EXECUTE FUNCTION update_updated_at_column();

  001_init.down.sql: |
    DROP TRIGGER IF EXISTS update_jobs_updated_at ON jobs;
    DROP FUNCTION IF EXISTS update_updated_at_column();
    DROP TABLE IF EXISTS jobs;

  002_performance_indexes.up.sql: |
    -- Add composite index for common status + date queries
    CREATE INDEX idx_jobs_status_created_at ON jobs(status, created_at DESC);

    -- Add index for filtering by completion time
    CREATE INDEX idx_jobs_completed_at ON jobs(completed_at DESC) WHERE completed_at IS NOT NULL;

    -- Add index for finding long-running jobs
    CREATE INDEX idx_jobs_processing_time ON jobs(processing_time_ms DESC) WHERE processing_time_ms IS NOT NULL;

    -- Add partial index for pending jobs (most common query)
    CREATE INDEX idx_jobs_pending ON jobs(created_at DESC) WHERE status = 'pending';

  002_performance_indexes.down.sql: |
    DROP INDEX IF EXISTS idx_jobs_pending;
    DROP INDEX IF EXISTS idx_jobs_processing_time;
    DROP INDEX IF EXISTS idx_jobs_completed_at;
    DROP INDEX IF EXISTS idx_jobs_status_created_at;

  003_add_users.up.sql: |
    -- Create users table
    CREATE TABLE IF NOT EXISTS users (
        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        email VARCHAR(255) NOT NULL UNIQUE,
        password_hash VARCHAR(255) NOT NULL,
        username VARCHAR(100) NOT NULL,
        created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
        updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
        last_login_at TIMESTAMP WITH TIME ZONE
    );

    -- Create indexes
    CREATE INDEX idx_users_email ON users(email);
    CREATE INDEX idx_users_username ON users(username);

    -- Add user_id to jobs table
    ALTER TABLE jobs ADD COLUMN user_id UUID REFERENCES users(id) ON DELETE CASCADE;
    CREATE INDEX idx_jobs_user_id ON jobs(user_id);

    -- Update existing jobs to have a system user (for backward compatibility)
    INSERT INTO users (id, email, password_hash, username)
    VALUES ('00000000-0000-0000-0000-000000000000', 'system@internal', '', 'system')
    ON CONFLICT (id) DO NOTHING;

    UPDATE jobs SET user_id = '00000000-0000-0000-0000-000000000000' WHERE user_id IS NULL;

    -- Make user_id NOT NULL after backfilling
    ALTER TABLE jobs ALTER COLUMN user_id SET NOT NULL;

    -- Create updated_at trigger for users
    CREATE TRIGGER update_users_updated_at
        BEFORE UPDATE ON users
        FOR EACH ROW
        EXECUTE FUNCTION update_updated_at_column();

  003_add_users.down.sql: |
    ALTER TABLE jobs DROP COLUMN user_id;
    DROP INDEX IF EXISTS idx_users_username;
    DROP INDEX IF EXISTS idx_users_email;
    DROP TRIGGER IF EXISTS update_users_updated_at ON users;
    DROP TABLE IF EXISTS users;

  004_add_cleanup.up.sql: |
    -- Add delete_at timestamp for automatic cleanup
    ALTER TABLE jobs ADD COLUMN delete_at TIMESTAMP WITH TIME ZONE;

    -- Create index for efficient cleanup queries
    CREATE INDEX idx_jobs_delete_at ON jobs(delete_at) WHERE delete_at IS NOT NULL;

    -- Add comment explaining the field
    COMMENT ON COLUMN jobs.delete_at IS 'Timestamp when this job and its associated files should be automatically deleted. Set to completed_at + retention period.';

  004_add_cleanup.down.sql: |
    DROP INDEX IF EXISTS idx_jobs_delete_at;
    ALTER TABLE jobs DROP COLUMN delete_at;
