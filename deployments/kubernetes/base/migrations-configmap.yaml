apiVersion: v1
kind: ConfigMap
metadata:
  name: db-migrations
  namespace: image-processor
data:
  001_init.up.sql: |
    -- Create jobs table
    CREATE TABLE IF NOT EXISTS jobs (
        id UUID PRIMARY KEY,
        status VARCHAR(20) NOT NULL DEFAULT 'pending',
        original_key VARCHAR(512) NOT NULL,
        processed_key VARCHAR(512),
        original_name VARCHAR(255) NOT NULL,
        content_type VARCHAR(100) NOT NULL,
        file_size BIGINT NOT NULL,
        operations JSONB NOT NULL DEFAULT '[]',
        error TEXT,
        progress INTEGER NOT NULL DEFAULT 0,
        worker_id VARCHAR(100),
        created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
        updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
        started_at TIMESTAMP WITH TIME ZONE,
        completed_at TIMESTAMP WITH TIME ZONE,
        processing_time_ms BIGINT
    );

    -- Create indexes for common queries
    CREATE INDEX idx_jobs_status ON jobs(status);
    CREATE INDEX idx_jobs_created_at ON jobs(created_at DESC);
    CREATE INDEX idx_jobs_worker_id ON jobs(worker_id) WHERE worker_id IS NOT NULL;

    -- Create updated_at trigger function
    CREATE OR REPLACE FUNCTION update_updated_at_column()
    RETURNS TRIGGER AS $$
    BEGIN
        NEW.updated_at = NOW();
        RETURN NEW;
    END;
    $$ language 'plpgsql';

    -- Create trigger for updated_at
    CREATE TRIGGER update_jobs_updated_at
        BEFORE UPDATE ON jobs
        FOR EACH ROW
        EXECUTE FUNCTION update_updated_at_column();

  001_init.down.sql: |
    DROP TRIGGER IF EXISTS update_jobs_updated_at ON jobs;
    DROP FUNCTION IF EXISTS update_updated_at_column();
    DROP TABLE IF EXISTS jobs;

  002_performance_indexes.up.sql: |
    -- Add composite index for common status + date queries
    CREATE INDEX idx_jobs_status_created_at ON jobs(status, created_at DESC);

    -- Add index for filtering by completion time
    CREATE INDEX idx_jobs_completed_at ON jobs(completed_at DESC) WHERE completed_at IS NOT NULL;

    -- Add index for finding long-running jobs
    CREATE INDEX idx_jobs_processing_time ON jobs(processing_time_ms DESC) WHERE processing_time_ms IS NOT NULL;

    -- Add partial index for pending jobs (most common query)
    CREATE INDEX idx_jobs_pending ON jobs(created_at DESC) WHERE status = 'pending';

  002_performance_indexes.down.sql: |
    DROP INDEX IF EXISTS idx_jobs_pending;
    DROP INDEX IF EXISTS idx_jobs_processing_time;
    DROP INDEX IF EXISTS idx_jobs_completed_at;
    DROP INDEX IF EXISTS idx_jobs_status_created_at;
