apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: image-processor-api
  namespace: image-processor
  labels:
    app: api
    release: prometheus
spec:
  selector:
    matchLabels:
      app: api
  endpoints:
    - port: http
      path: /metrics
      interval: 30s
      scrapeTimeout: 10s
---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: image-processor-worker
  namespace: image-processor
  labels:
    app: worker
    release: prometheus
spec:
  selector:
    matchLabels:
      app: worker
  endpoints:
    - port: http
      path: /metrics
      interval: 30s
      scrapeTimeout: 10s
---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: image-processor-alerts
  namespace: image-processor
  labels:
    prometheus: kube-prometheus
    role: alert-rules
spec:
  groups:
    - name: image-processor
      interval: 30s
      rules:
        - alert: HighErrorRate
          expr: |
            rate(image_processor_api_http_requests_total{status=~"5.."}[5m])
            / rate(image_processor_api_http_requests_total[5m]) > 0.05
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "High error rate detected"
            description: "Error rate is above 5% for the last 5 minutes"

        - alert: APIDown
          expr: up{job="api"} == 0
          for: 2m
          labels:
            severity: critical
          annotations:
            summary: "API service is down"
            description: "API service has been down for more than 2 minutes"

        - alert: WorkerDown
          expr: up{job="worker"} == 0
          for: 2m
          labels:
            severity: critical
          annotations:
            summary: "Worker service is down"
            description: "Worker service has been down for more than 2 minutes"

        - alert: HighMemoryUsage
          expr: |
            container_memory_usage_bytes{namespace="image-processor",pod=~"api.*"}
            / container_spec_memory_limit_bytes{namespace="image-processor",pod=~"api.*"} > 0.9
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "High memory usage detected"
            description: "Memory usage is above 90% for the last 5 minutes"

        - alert: HighCPUUsage
          expr: |
            rate(container_cpu_usage_seconds_total{namespace="image-processor",pod=~"api.*"}[5m]) > 0.8
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "High CPU usage detected"
            description: "CPU usage is above 80% for the last 10 minutes"

        - alert: JobQueueBacklog
          expr: redis_stream_length{stream="image-jobs"} > 100
          for: 15m
          labels:
            severity: warning
          annotations:
            summary: "Job queue backlog detected"
            description: "More than 100 jobs in queue for 15 minutes"

        - alert: DatabaseConnectionIssue
          expr: image_processor_api_db_connections_active > 20
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "High number of database connections"
            description: "More than 20 active database connections"
